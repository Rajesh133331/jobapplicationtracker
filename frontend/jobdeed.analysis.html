<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Analysis</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:#f8faf9;
      color:#0b3b33;
    }
    h3{
      text-align:center;
      margin:18px 0;
    }
    #login{
      display:none;
      text-align:center;
      margin-top:6px;
    }
    #stats{
      display:flex;
      gap:12px;
      justify-content:center;
      flex-wrap:wrap;
      margin:8px auto 0;
    }
    .card{
      background:#fff;
      border:1px solid #d9e5e1;
      border-radius:12px;
      box-shadow:0 6px 18px rgba(0,0,0,.06);
      padding:10px 14px;
      min-width:150px;
      text-align:center;
    }
    .card h4{
      margin:0;
      font-size:13px;
      color:#4b6b63;
    }
    .big{
      font-size:22px;
      font-weight:800;
      margin-top:4px;
      color:#1b2f2b;
    }
    #charts{
      display:flex;
      gap:28px;
      justify-content:center;
      flex-wrap:wrap;
      margin:16px auto 40px;
      max-width:1100px;
    }
    canvas{
      background:#fff;
      border:1px solid #d9e5e1;
      border-radius:12px;
      box-shadow:0 6px 18px rgba(0,0,0,.06);
    }
    #barReasons{
      width:420px;
      height:320px;
    }
    #pieEdu{
      width:320px;
      height:320px;
    }
    #doughStart{
      width:360px;
      height:320px;
    }
  </style>
</head>
<body>
  <h3 id="title">Analysis</h3>
  <a id="login" href="http://127.0.0.1:5500/login.html">Login</a>
  <div id="stats">
    <div class="card">
      <h4>Total Users</h4>
      <div class="big" id="total">–</div>
    </div>
    <div class="card">
      <h4>Onboarded</h4>
      <div class="big" id="onb">–</div>
    </div>
    <div class="card">
      <h4>Completion %</h4>
      <div class="big" id="pct">–</div>
    </div>
  </div>
  <div id="charts">
    <canvas id="barReasons"></canvas>
    <canvas id="pieEdu"></canvas>
    <canvas id="doughStart"></canvas>
  </div>

  <script>
    if(localStorage.getItem("premiumuser")!=="true"){
      document.body.innerHTML="<h3 style='text-align:center'>Access denied</h3><p style='text-align:center'>You don't have access to analysis. Please upgrade to premium.</p>";
      throw new Error("non-premium");
    }
    const token=localStorage.getItem("token");
    if(!token){
      document.getElementById("title").textContent="Unauthorized";
      document.getElementById("login").style.display="block";
      throw new Error("no token");
    }
    function makePalette(n){
      return Array.from({length:n},(_,i)=>`hsl(${(i*47)%360} 70% 55%)`);
    }
    function objToArrays(o){
      const k=Object.keys(o||{});
      return {labels:k,values:k.map(x=>Number(o[x])||0)};
    }
    axios.get("http://localhost:8080/analytics",{headers:{Authorization:"Bearer "+token}})
    .then(r=>{
      const d=r.data||{};
      const total=Number(d?.totals?.users||0);
      const onb=Number(d?.totals?.onboarded||0);
      const pct=total?Math.round((onb/total)*100):0;
      document.getElementById("total").textContent=total;
      document.getElementById("onb").textContent=onb;
      document.getElementById("pct").textContent=pct+"%";
      const rs=objToArrays(d.reasons);
      const ed=objToArrays(d.education);
      const st=objToArrays(d.start);
      const ctxR=document.getElementById("barReasons").getContext("2d");
      new Chart(ctxR,{
        type:"bar",
        data:{labels:rs.labels,datasets:[{data:rs.values,backgroundColor:makePalette(rs.labels.length)}]},
        options:{responsive:false,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{precision:0}}}}
      });
      const ctxE=document.getElementById("pieEdu").getContext("2d");
      new Chart(ctxE,{
        type:"pie",
        data:{labels:ed.labels,datasets:[{data:ed.values,backgroundColor:makePalette(ed.labels.length)}]},
        options:{responsive:false,maintainAspectRatio:false,plugins:{legend:{position:"bottom"}}}
      });
      const ctxS=document.getElementById("doughStart").getContext("2d");
      new Chart(ctxS,{
        type:"doughnut",
        data:{labels:st.labels,datasets:[{data:st.values,backgroundColor:makePalette(st.labels.length)}]},
        options:{responsive:false,maintainAspectRatio:false,plugins:{legend:{position:"bottom"}}}
      });
    })
    .catch(e=>{
      if(e.response&&e.response.status===401){
        document.getElementById("title").textContent="Unauthorized";
        document.getElementById("login").style.display="block";
      }else{
        document.getElementById("title").textContent="Analysis (failed to load)";
        console.error(e);
      }
    });
  </script>
</body>
</html>
